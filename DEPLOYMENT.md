# DeployX — Deployment Guide

## Prerequisites

| Requirement        | Minimum          | Notes                                       |
| ------------------ | ---------------- | ------------------------------------------- |
| VPS / Server       | 1 vCPU, 1 GB RAM | Ubuntu 22.04 / Debian 12 recommended        |
| Docker             | 24.0+            | Installed automatically by `quick-start.sh` |
| Docker Compose     | v2 (plugin)      | Installed automatically                     |
| Domain             | Any registrar    | DNS managed by Cloudflare (free plan works) |
| Cloudflare account | Free tier        | Required for tunnel + DNS                   |

---

## 1. One-Command Bootstrap

```bash
git clone https://github.com/<your-org>/deployx.git
cd deployx/project
chmod +x quick-start.sh
sudo ./quick-start.sh
```

The script performs six steps:

| Step | Action                                                                         |
| ---- | ------------------------------------------------------------------------------ |
| 1    | Detect OS & install Docker + Compose if missing                                |
| 2    | Ensure current user is in the `docker` group                                   |
| 3    | Generate `.env` from `.env.example` (random `SECRET_KEY`, `POSTGRES_PASSWORD`) |
| 4    | Build all Docker images                                                        |
| 5    | Start containers via `docker compose up -d`                                    |
| 6    | Wait for backend health (`/api/health`) with 60 s timeout                      |

On completion the script prints:

```
═══════════════════════════════════════
  DeployX is running!
  Dashboard : http://<ip>:3000
  API       : http://<ip>:3000/api
  Traefik   : http://<ip>:8080
═══════════════════════════════════════
```

---

## 2. First-Time Onboarding (Web UI)

After the platform starts, open `http://<server-ip>:3000` in your browser.

### Step 2a — Create Admin Account

The root page detects no admin exists (`GET /api/platform/status → has_admin: false`) and redirects you to `/auth/register`.

- Enter email, username, password.
- The **first registered user** is automatically marked as superuser.

### Step 2b — Log In

After registration you are redirected to `/auth/login`. Sign in with the credentials you just created.

### Step 2c — Configure Cloudflare Tunnel

The dashboard shows an **onboarding banner** prompting you to set up Cloudflare Tunnel.

1. Go to the **Cloudflare Tunnel** tab.
2. Enter your **Cloudflare Global API Token** (or scoped token with Zone + Tunnel permissions).
3. Enter your **domain** (e.g. `example.com`) and desired **subdomain** (e.g. `deploy`).
4. Click **Setup Tunnel**.

The backend will:

- Validate the API token.
- Look up the Cloudflare zone and account id.
- Create a Named Tunnel via the Cloudflare API.
- Add a CNAME DNS record `deploy.example.com → <tunnel-id>.cfargotunnel.com`.
- Configure the tunnel to route traffic to `http://traefik:80`.
- Persist the tunnel token into the `.env` file.
- Store the configuration in PostgreSQL.

After setup, your platform is publicly reachable at `https://deploy.example.com` with Cloudflare-managed HTTPS.

---

## 3. Environment Variables

All runtime config lives in `.env` (auto-generated by the bootstrap):

| Variable               | Default                     | Description                      |
| ---------------------- | --------------------------- | -------------------------------- |
| `POSTGRES_USER`        | `deployx`                   | Database username                |
| `POSTGRES_PASSWORD`    | _(generated)_               | Database password                |
| `POSTGRES_DB`          | `deployx`                   | Database name                    |
| `SECRET_KEY`           | _(generated)_               | JWT signing key                  |
| `NEXT_PUBLIC_API_URL`  | `http://<ip>:3000`          | API base URL seen by the browser |
| `BACKEND_CORS_ORIGINS` | `["http://localhost:3000"]` | Allowed origins (JSON array)     |
| `TUNNEL_TOKEN`         | _(empty)_                   | Populated after Cloudflare setup |
| `PUBLIC_URL`           | _(empty)_                   | Populated after tunnel setup     |

---

## 4. Docker Compose Services

```bash
docker compose ps
```

| Service       |  Port Binding   | Depends On                |
| ------------- | :-------------: | ------------------------- |
| `frontend`    |   `3000:3000`   | backend                   |
| `backend`     |  _(internal)_   | postgres                  |
| `postgres`    |  _(internal)_   | —                         |
| `traefik`     | `80, 443, 8080` | frontend, backend         |
| `cloudflared` |  _(internal)_   | traefik (profile: tunnel) |

### Activating the Tunnel Manually

If you prefer CLI over the UI:

```bash
# Set the token
echo 'TUNNEL_TOKEN=eyJh...' >> .env

# Start cloudflared
docker compose --profile tunnel up -d cloudflared
```

---

## 5. Verifying the Deployment

```bash
# Health check
curl http://localhost:3000/api/health

# Platform status
curl http://localhost:3000/api/platform/status

# Run the included verification script
chmod +x verify.sh
./verify.sh
```

Expected health response:

```json
{
  "status": "healthy",
  "database": "connected",
  "version": "1.0.0"
}
```

---

## 6. Updating

```bash
cd deployx/project
git pull origin main
docker compose build --no-cache
docker compose up -d
```

Zero-downtime updates are possible by running:

```bash
docker compose up -d --build --force-recreate --remove-orphans
```

---

## 7. Backup & Restore

### Backup PostgreSQL

```bash
docker compose exec postgres pg_dump -U deployx deployx > backup_$(date +%F).sql
```

### Restore

```bash
cat backup_2024-01-15.sql | docker compose exec -T postgres psql -U deployx deployx
```

---

## 8. Monitoring

| Tool                   | URL                                    | Purpose                              |
| ---------------------- | -------------------------------------- | ------------------------------------ |
| Traefik Dashboard      | `http://<ip>:8080`                     | Route table, middleware, entrypoints |
| `/api/health`          | `http://<ip>:3000/api/health`          | API + DB connectivity                |
| `/api/platform/status` | `http://<ip>:3000/api/platform/status` | Onboarding & service status          |
| Docker logs            | `docker compose logs -f <service>`     | Per-service log tailing              |

---

## 9. Uninstalling

```bash
docker compose --profile tunnel down -v   # stops all + removes volumes
rm .env                                    # remove secrets
```

---

## 10. Troubleshooting

| Symptom                | Likely Cause                       | Fix                                                     |
| ---------------------- | ---------------------------------- | ------------------------------------------------------- |
| `quick-start.sh` fails | Docker not installed / not in PATH | Run `curl -fsSL https://get.docker.com \| sh` manually  |
| Backend unhealthy      | Postgres not ready                 | `docker compose restart backend`                        |
| 502 on tunnel URL      | Traefik → backend route missing    | Check `docker compose logs traefik` for provider errors |
| DNS not resolving      | CNAME not propagated               | Wait 1-2 min; verify in Cloudflare dashboard            |
| Login returns 401      | Wrong password or expired JWT      | Re-login; check `SECRET_KEY` hasn't changed             |
